name: Build with Fixed Gradle Files

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Fix Gradle files
      run: |
        # Fix settings.gradle filename
        if [ -f "setting.gradle" ]; then
          mv setting.gradle settings.gradle
        fi
        
        # Create proper root build.gradle
        cat > build.gradle << 'EOF'
        // Top-level build file where you can add configuration options common to all sub-projects/modules.
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath "com.android.tools.build:gradle:8.1.0"
                classpath "com.chaquo.python:gradle:14.0.2"
            }
        }
        
        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        
        # Create proper settings.gradle
        cat > settings.gradle << 'EOF'
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        
        rootProject.name = "Customer-Info"
        include ':app'
        EOF
        
        # Fix directory structure
        mkdir -p app/src/main
        if [ -d "app/java" ]; then
          mv app/java app/src/main/java
        fi
        if [ -d "app/python" ]; then
          mv app/python app/src/main/python
        fi
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Build Android APK
      run: |
        gradle clean assembleDebug --stacktrace
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: BPDB-App
        path: "app/build/outputs/apk/**/*.apk"
        if-no-files-found: warn
