name: Build BPDB Android App

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Fix project structure
      run: |
        # Fix settings.gradle filename
        if [ -f "setting.gradle" ]; then
          mv setting.gradle settings.gradle
          echo "✓ Fixed settings.gradle filename"
        fi
        
        # Fix directory structure for Android standards
        mkdir -p app/src/main/java/customerinfo/app
        mkdir -p app/src/main/python
        
        # Copy Java files to correct location
        if [ -d "app/java" ]; then
          find app/java -name "*.java" -exec cp {} app/src/main/java/customerinfo/app/ \;
          echo "✓ Copied Java files"
        fi
        
        # Copy Python files to correct location  
        if [ -d "app/python" ]; then
          cp -r app/python/* app/src/main/python/ || true
          echo "✓ Copied Python files"
        fi
        
        # Copy AndroidManifest to correct location
        if [ -f "app/AndroidManifest.xml" ] && [ ! -f "app/src/main/AndroidManifest.xml" ]; then
          mkdir -p app/src/main
          cp app/AndroidManifest.xml app/src/main/
          echo "✓ Fixed AndroidManifest location"
        fi
        
        # Verify structure
        echo "=== Final Structure ==="
        find app/src -type f | head -10
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Build Android APK
      run: |
        gradle clean assembleDebug --stacktrace --info
        
    - name: Find and list APK files
      run: |
        find . -name "*.apk" -type f || echo "No APK files found"
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: BPDB-Meter-Lookup-App
        path: "**/build/outputs/apk/**/*.apk"
        if-no-files-found: warn
